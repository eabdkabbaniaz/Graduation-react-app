var NewDrugs = [
    {
        "Name": "Empty",
        "ShortName": "E",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E30,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E30,
        "EC50_Alpha2_AdrenR": 1E30,
        "EC50_Beta_AdrenR": 1E30,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "Competitive": false,
        "BathConcentration": 0.0
    },
    {
        "Name": "Acetylcholine",
        "ShortName": "Ach",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 5E-4,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 4.2E-7,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E30,
        "EC50_Alpha2_AdrenR": 1E30,
        "EC50_Beta_AdrenR": 1E30,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "FinalBathConcentration": 0.0,
        "Competitive": false,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
    {
        "Name": "Barium",
        "ShortName": "Ba",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 5E-5,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 5E-8,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E30,
        "EC50_Alpha2_AdrenR": 1E30,
        "EC50_Beta_AdrenR": 1E30,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "Competitive": false,
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
    {
        "Name": "Noradrenaline (Norepinephrine)",
        "ShortName": "Nor",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E30,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 5E-6,
        "EC50_Alpha2_AdrenR": 5E-6,
        "EC50_Beta_AdrenR": 1E-5,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "Competitive": false,
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
    {
        "Name": "Atropine",
        "ShortName": "Atropine",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E-7, // نفس المستقبل يلي بيرتبط فيه Ach
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E30,
        "EC50_Alpha2_AdrenR": 1E30,
        "EC50_Beta_AdrenR": 1E30,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": true, // <— هاي الأهم
        "FinalBathConcentration": 0.0,
        "Competitive": false,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 1e-6 // أو حسب تركيز التجربة
    },
    {
        "Name": "Adrenaline (Epinephrine)",
        "ShortName": "Adr",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E30,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E-5 * RandG(1.0, 0.05),
        "EC50_Alpha2_AdrenR": 1E-5,
        "EC50_Beta_AdrenR": 5E-6 * RandG(1.0, 0.05),
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "Competitive": false,
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
    {
        "Name": "Alpha Beta Blocker",
        "ShortName": "al",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E30,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E30,
        "EC50_Alpha2_AdrenR": 1E30,
        "EC50_Beta_AdrenR": 1E30,
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1.0,
        "Tissue": 0,
        "Units": "M",
        "Unknown": "True",
        "Antagonist": "True",
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
    {
        "Name": "Magnisum",
        "ShortName": "Mag",
        "EC50_HistR": 1E30,
        "EC50_HistR_NC": 1E30,
        "EC50_nAchR": 1E30,
        "EC50_AchEsterase": 1E30,
        "EC50_mAchR": 1E30,
        "EC50_mAchR_NC": 1E30,
        "EC50_OpR": 1E30,
        "EC50_Alpha_AdrenR": 1E-5 * RandG(1.0, 0.05),
        "EC50_Alpha2_AdrenR": 1E-5,
        "EC50_Beta_AdrenR": 5E-6 * RandG(1.0, 0.05),
        "EC50_PLC_Inhibition": 1E30,
        "EC50_CaChannelR": 1E30,
        "EC50_CaStore": 1E30,
        "EC50_BTXE": 1E30,
        "EC50_BTXB": 1E30,
        "EC50_NaChannel": 1E30,
        "EC50_KChannel": 1E30,
        "EC50_ECCoupling": 1E30,
        "EC50_Ca": 1E30,
        "EC50_CaChannelV": 1E30,
        "EC50_IP3R": 1E30,
        "EC50_Mg": 1E30,
        "Tissue": 0,
        "Units": "M",
        "Unknown": false,
        "Antagonist": false,
        "Competitive": false,
        "FinalBathConcentration": 0.0,
        "DisplayBathConcentration": 0.0,
        "BathConcentration": 0.0
    },
];
var atrBloker = 0.0;
const BathVolume = 10;
const MeanRMax = 15.0;
const RMaxStDev = 0.05;
const MaxMixingRate = 0.5;
var dt = 0.15;
const mAch_EC50 = 1E-6;
const Period = 7.0;
const NerveNorAdrReleaseRate = 0.03 * 1E-6;
const NerveNorAdrUptakeRate = 0.1;
BackgroundNoiseStDev = 0.075;
var StimFrequency = 0.2;
var betaidxNorAdrenaline = 1E-5 * RandG(1.0, 0.05);
var idxNorAdrenaline = 5E-6 * RandG(1.0, 0.05);
var i;
var Alpha_AdrenR; // Alpha adrenoceptor activation
var Beta_AdrenR; // Beta adrenoceptor activation
var Efficacy, OccupancySum;
var Occupancy, EfficacySum;
var CyclicContraction;
var A;
var dNorAdr;
var NerveNorAdrRelease;
var NerveReleasedAch;
var mAchR;
var NerveReleasedNorAdrenaline = 0;
var MaxReleasedAch = mAch_EC50 * 4.0;
var mAchR;
var MixingRate;
var InitialMixing = 1;
var Rmax = 0;
var EfficacySum = 0;
var NerveStimulationOn = true;
var NerveReleasedAch = 0.0;
var ChanValues = 0.0;
var t = 0;
var Id = 0;
var Drugs;
let vNorAdr = 0;
var y;
var factor;
var randomEffect;
var L;
var initialArray;
var newFinalBathConcentration = 0.0;
var AddedConcentration = 0.0;
var newDisplayBathConcentration = 0.0;
const NorepinephrineDegradationRate = 0.05; // قيمة افتراضية لمعدل التحلل
var y = true;
var x = RandG(0.0, BackgroundNoiseStDev);

function RandG(mean, stdDev) {
    const u = 1 - Math.random();
    const v = Math.random();
    const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    return z * stdDev + mean;
}
function Cleans() {
    WashoutActive = true;
    timer = true
    data=0;
 array = [];
console.log("i am walaaaaaaaa") 
    te = true;
    // for (i = 0; i < Drugs.length; i++) {
    //     Drugs[i]["BathConcentration"] = 0.0;
    //     Drugs[i]["DisplayBathConcentration"] = 0.0;
    //     Drugs[i]["FinalBathConcentration"] = 0.0;

    // }
    atrBloker = 0;
    vNorAdr = 0;
    Id = 0;
    x = 0;
    y = true;
    InitialMixing = 1;//هاد اثر على حساب الاستيل كولين في النتيجة
    NerveReleasedAch = 0.0;
    AddedConcentration = 0.0;
    newDisplayBathConcentration = 0.0;
}
function Clean() {
    // WashoutActive = true;
    timer = true
    data=0;
 array = [];
console.log("i am walaaaaaaaa") 
    te = true;
    for (i = 0; i < Drugs.length; i++) {
        Drugs[i]["BathConcentration"] = 0.0;
        Drugs[i]["DisplayBathConcentration"] = 0.0;
        Drugs[i]["FinalBathConcentration"] = 0.0;

    }
    atrBloker = 0;
    vNorAdr = 0;
    Id = 0;
    x = 0;
    y = true;
    InitialMixing = 1;//هاد اثر على حساب الاستيل كولين في النتيجة
    NerveReleasedAch = 0.0;
    AddedConcentration = 0.0;
    newDisplayBathConcentration = 0.0;
}
function initial() {
    RmaxCalc();
    BackgroundNoiseStDevfunc();
    randomEffect = Math.random() * (0.07 - 0.05) + 0.05;
    factor = 20 + (Math.random() * (40 - 20))
    Drugs = NewDrugs;
    randNum = RandG(1.0, 0.1);
    initialArray = Math.random() * (0.002 - 0.00001) + 0.00001;
}
function FinalBathConcentration(StockConcentration, DrugsId, Volume) {
    Id = DrugsId;
    vNorAdr = Volume;
    AddedConcentration = (StockConcentration * Volume) / BathVolume;
    newDisplayBathConcentration = (Drugs[DrugsId].DisplayBathConcentration + AddedConcentration).toFixed(10);
    newFinalBathConcentration = (Drugs[DrugsId].FinalBathConcentration + AddedConcentration * randNum).toFixed(10);
    updatBathConcentration();

}

WashoutActive=false
// function wash() {
//     const MixingRate = 0.5;
//     const WashoutRate = 0.1; // كل دورة زمنية ينقص 10% من التركيز
    
//     for (let i = 0; i < Drugs.length; i++) {
//         if (WashoutActive) {
//             // خفّض التركيز تدريجياً''
//             console.log("hiiiiiiiiii")
//             Drugs[i].FinalBathConcentration *=100*(1 - WashoutRate);
//             Drugs[i].BathConcentration *=100*(1 - WashoutRate);
//             Drugs[i].DisplayBathConcentration *=100*(1 - WashoutRate);
//         }

//         let dConc = (Drugs[i].FinalBathConcentration - Drugs[i].BathConcentration) * dt;
//         Drugs[i].BathConcentration = Math.max(Drugs[i].BathConcentration + dConc, 0);
//         // Drugs[i].BathConcentration = Math.max(Drugs[i].BathConcentration + dConc, 0);
//     }
    
//     InitialMixing += 1;
    
//     // إيقاف الغسل إذا أصبحت كل التراكيز صغيرة جداً
//     if (WashoutActive) {
//         // let total = Drugs.reduce((sum, d) => sum + d.FinalBathConcentration, 0);
//         if (Drugs['Id'],FinalBathConcentration<=0.05) {
//              for (i = 0; i < Drugs.length; i++) {
//         Drugs[i]["BathConcentration"] = 0.0;
//         Drugs[i]["DisplayBathConcentration"] = 0.0;
//         Drugs[i]["FinalBathConcentration"] = 0.0;

//     }
   
//             WashoutActive = false;
//         }
//     }
// }
function wash() {
    const MixingRate = 0.5;
    const WashoutRate = 0.1; // 10% decrease per cycle
    const threshold = 0; // Threshold to stop washout
    let allBelowThreshold = true;

    for (let i = 0; i < Drugs.length; i++) {
        if (WashoutActive) {
            // خفّض التراكيز تدريجيًا بنسبة 10%
            Drugs[i].FinalBathConcentration *= (1 - WashoutRate);
            Drugs[i].BathConcentration *= (1 - WashoutRate);
            Drugs[i].DisplayBathConcentration *= (1 - WashoutRate);
        }

        // // احسب الفرق وحدث التركيز الحقيقي
        // let dConc = (Drugs[i].FinalBathConcentration - Drugs[i].BathConcentration) * dt;
        // Drugs[i].BathConcentration = Math.max(Drugs[i].BathConcentration + dConc, 0);

        // تحقق إذا كان أي تركيز ما يزال أعلى من العتبة
        if (Drugs[i].FinalBathConcentration > threshold) {
            allBelowThreshold = false;
        }
    }

    InitialMixing += 1; // تأكد أن هذا المتغير معرف في الخارج

    // أوقف الغسل إذا كانت جميع التراكيز تحت العتبة
    if (WashoutActive && allBelowThreshold) {
        for (let i = 0; i < Drugs.length; i++) {
            Drugs[i].FinalBathConcentration = 0.0;
            Drugs[i].BathConcentration = 0.0;
            Drugs[i].DisplayBathConcentration = 0.0;
        }
        WashoutActive = false;
    }
}

function updatBathConcentration() {
    MixingRate = (MaxMixingRate * InitialMixing) / (100.0 + InitialMixing);
    for (i = 0; i < Drugs.length; i++) {
        dConc = (Drugs[i].FinalBathConcentration - Drugs[i].BathConcentration) * MixingRate * dt;
        Drugs[i].BathConcentration = Math.max(Drugs[i].BathConcentration + dConc);
    }

    InitialMixing = InitialMixing + 1;
}
function Update() {
    Drugs[Id].DisplayBathConcentration = parseFloat(newDisplayBathConcentration);
    Drugs[Id].FinalBathConcentration = parseFloat(newFinalBathConcentration);
    updatBathConcentration();
    //         if(Id==4 && atrBloker==0){
    //       Atropine();

    // }
}

function BackgroundNoiseStDevfunc() {
    BackgroundNoiseStDev = 0.3 + (Math.random() * (0.5 - 0.3));
}

function RmaxCalc() {
    Rmax = MeanRMax * RandG(1.0, RMaxStDev);
}

function stimulation() {
       wash();
    var [x, y] = test1();
    return { x, y };
}
function ner() {
    if (NerveStimulationOn)
        NerveNorAdrRelease = StimFrequency * NerveNorAdrReleaseRate;
    else
        NerveNorAdrRelease = 0.0;
    let uptake = NerveReleasedNorAdrenaline * NerveNorAdrUptakeRate;
    let degradation = NerveReleasedNorAdrenaline * NorepinephrineDegradationRate;
    dNorAdr = NerveNorAdrRelease - uptake - degradation;
    NerveReleasedNorAdrenaline = Math.max(NerveReleasedNorAdrenaline + dNorAdr, 0.0);
}
function calculateReceptorActivation(type, nerveLevel, idxName, EC50Prop) {
    let occupancySum = nerveLevel / idxName;
    let efficacySum = occupancySum;
    for (let i = 0; i < 2; i++) {
        const drug = Drugs[i];
        const EC50 = drug[EC50Prop];
        const conc = drug.BathConcentration;
        occupancySum += conc / EC50;
        if (!drug.Antagonist) efficacySum += conc / EC50;
    }
    const occupancy = occupancySum / (1.0 + occupancySum);
    const efficacy = efficacySum / (occupancySum + 0.001);
    // console.log("occupancy"+occupancy)
    // console.log("efficacy"+efficacy)
    return efficacy * occupancy;
}

function Alpha() {
    Alpha_AdrenR = calculateReceptorActivation("Alpha", NerveReleasedNorAdrenaline, idxNorAdrenaline, "EC50_Alpha_AdrenR");
}

function Atropine() {
    atrBloker += 5 * calculateReceptorActivation("mAch", 4, mAch_EC50, "EC50_mAchR") + 500 * Drugs[4].FinalBathConcentration;
    console.log("atrBloker0   " + atrBloker)

}

function BetaAdrenoceptorActivation() {
    Beta_AdrenR = calculateReceptorActivation("Beta", NerveReleasedNorAdrenaline, betaidxNorAdrenaline, "EC50_Beta_AdrenR");
}

function alphaAndBetaAdrenoceptors() {
    const A = Math.sin((2 * Math.PI * t) / Period);
    CyclicContraction = Math.pow(A, 4) *
        Math.max(1.0 - 2.0 * (Alpha_AdrenR / (1.0 + Alpha_AdrenR)) - 2.0 * (Beta_AdrenR / (1.0 + Beta_AdrenR)), 0.0);

    NerveReleasedAch = CyclicContraction * mAch_EC50;
    mAchR = calculateReceptorActivation("mAch", NerveReleasedAch, mAch_EC50, "EC50_mAchR");
}

function handleAdrenalineEffect() {
    if (y == true) {
        ChanValues = ChanValues - 1000 * Drugs[Id].FinalBathConcentration - mAchR * vNorAdr * factor;
    }
    else if (y == false) {
        // console.log("randomeffect:" + randomEffect)
        ChanValues = (ChanValues - 1000 * Drugs[Id].FinalBathConcentration);
    }
}
te = true;
// function Rabbit() {
//     //    wash();
   
//     ner();
//     Alpha();
//     BetaAdrenoceptorActivation();
//     alphaAndBetaAdrenoceptors();
//     const drug = Drugs[Id];
//     const finalConc = 1000 * drug.FinalBathConcentration;
//     ChanValues = finalConc + Rmax * Math.min(mAchR, 1.0);
//     // console.log(ChanValues)
//     if (drug.Name == "Atropine") {
//         //   Atropine();
//         ChanValues = Rmax * Math.min(mAchR, 1.0);
//     }
//     if (drug.Name == "Acetylcholine" && drug.FinalBathConcentration != 0) {
//         if (Drugs[4].FinalBathConcentration != -0.0) {
//             tt = true
//             // array[]
//             let array = [];
//             // let maxNumber = 0;
//             if (te) {
//                 var time = t;
//                 while (tt) {
//                     te = false;
//                     let newData = test();
//                     array.push(parseFloat(newData));  // ✅ استخدام push بدلاً من add
//                     array.forEach((value, index) => {
//                         console.log(`array[${index}] = ${value}, type: ${typeof value}`);
//                     });

//                     // console.log("newData" + array)
//                     // نتحقق إذا القيمة السابقة أقل من الحالية (تزايد)
//                     if (array[array.length - 1] < array[array.length - 2]) {
//                         // let maxNumber = Math.max(...array);

//                         // console.log("newData type: ", typeof maxNumber, " value: ", maxNumber);

//                         // console.log("maxNumber" + maxNumber)
//                         console.log("array.length" + array.length)

//                         if (array[array.length - 2] <= 7) {
//                             console.log("walaaaaaaaa")
//                             Clean();
//                             ChanValues = Rmax * Math.min(mAchR, 1.0);
//                             t = time
//                             tt = false;
//                         t+=dt
//                         tt = false;
//                         // break;
// return [ChanValues,t]  
//                         }

//                         ChanValues -= atrBloker; // تعديل تأثير الأتروبين
//                         t = time
//                         t+=dt
//                         tt = false;
//                         // break;
// return [ChanValues,t]                    
//                     }
//                 }

//             }
//         }
//         // else{
//         //     Clean();
//         //         ner();
//         //     Alpha();
//         //     BetaAdrenoceptorActivation();
//         //     alphaAndBetaAdrenoceptors();

//         //     ChanValues =  Rmax * Math.min(mAchR, 1.0);

//         // }
//     }
//     // console.log(AddedConcentration + "AddedConcentration")
//     if (initialArray <= AddedConcentration) {
//         switch (drug.Name) {
//             case "Adrenaline (Epinephrine)":
//                 handleAdrenalineEffect();
//                 break;
//                 // case "Acetylcholine":
//                 // case "Atropine":
//                 Atropine();
//             // ChanValues =  Rmax * Math.min(mAchR, 1.0);

//             // break;
//             // case "Acetylcholine":
//             // ChanValues -= atrBloker;
//             //     break;
//             case "Alpha Beta Blocker":
//                 L = vNorAdr;
//                 y = false;
//                 ChanValues -= finalConc;
//                 break;
//             case "Magnisum":
//                 ChanValues -= finalConc + mAchR * vNorAdr * factor;
//                 break;
//             case "Barium":
//                 // console.log(drug.FinalBathConcentration+"drug.FinalBathConcentration")
//                 if (drug.FinalBathConcentration > 0.0053732519)
//                     drug.FinalBathConcentration = 0.0053732519;
//                 ChanValues = 1000 * drug.FinalBathConcentration + Rmax * Math.min(mAchR, 1.0);
//                 break;
//         }
//         if (ChanValues > Rmax + 4) {
//             ChanValues = Rmax + 4;
//         }
//         if (ChanValues < 0.05 && Id !== 0) {
//             Update();
//         }
//         if (ChanValues < 0.05 && Id == 4 && atrBloker == 0) {

//             Atropine();


//         }
//     }
//     t += dt;
//     ChanValues = Math.max(ChanValues, 0);
//     return [ChanValues, t];
// }

function test() {
    ner();
    Alpha();
    BetaAdrenoceptorActivation();
    alphaAndBetaAdrenoceptors(); // لتحديث mAchR و NerveReleasedAch
    const drug = Drugs[Id];
    const finalConc = 1000 * drug.FinalBathConcentration;
    ChanValues = finalConc + Rmax * Math.min(mAchR, 1.0);

    if (drug.Name == "Atropine") {
        ChanValues = Rmax * Math.min(mAchR, 1.0);
    }
    if (drug.Name == "Acetylcholine" && drug.FinalBathConcentration != 0) {
        ChanValues -= atrBloker;
    }

    if (initialArray <= AddedConcentration) {
        switch (drug.Name) {
            case "Adrenaline (Epinephrine)":
                handleAdrenalineEffect();
                break;
            case "Alpha Beta Blocker":
                L = vNorAdr;
                y = false;
                ChanValues -= finalConc;
                break;
            case "Magnisum":
                ChanValues -= finalConc + mAchR * vNorAdr * factor;
                break;
            case "Barium":
                if (drug.FinalBathConcentration > 0.0053732519)
                    drug.FinalBathConcentration = 0.0053732519;
                ChanValues = 1000 * drug.FinalBathConcentration + Rmax * Math.min(mAchR, 1.0);
                break;
        }
        if (ChanValues > Rmax + 4) {
            ChanValues = Rmax + 4;
        }

        if (ChanValues < 0.05 && Id == 4 && atrBloker == 0) {
            Atropine();
        }
    }

    t += dt;
    ChanValues = Math.max(ChanValues, 0);
    // console.log(ChanValues + " ChanValues");

    return ChanValues;
}
timer = true
let array = [];
function test1() { 
    ner();
    Alpha();
    BetaAdrenoceptorActivation();
    alphaAndBetaAdrenoceptors(); // لتحديث mAchR و NerveReleasedAch
    const drug = Drugs[Id];
    const finalConc = 1000 * drug.FinalBathConcentration;
    ChanValues = finalConc + Rmax * Math.min(mAchR, 1.0);

    if (drug.Name == "Atropine") {
        ChanValues = Rmax * Math.min(mAchR, 1.0);
    }
    if (drug.Name == "Acetylcholine" && Drugs[4].FinalBathConcentration!=0 && drug.FinalBathConcentration != 0) {
        console.log("dddddddddddd")
        while(timer){
            data=test();
            array.push(data);
            if(data<array[array.length-2])
            {
                timer = false
                array.forEach((value, index) => {
                                    console.log(`array[${index}] = ${value}, type: ${typeof value}`);
                                });       

           if(array[array.length-2]<=8){
            Clean();
            ner();
            Alpha();
            BetaAdrenoceptorActivation();
            alphaAndBetaAdrenoceptors(); // لتحديث mAchR و NerveReleasedAch
            ChanValues = Rmax * Math.min(mAchR, 1.0);
 t += dt;
    ChanValues = Math.max(ChanValues, 0);
    console.log(ChanValues + " ChanValues");

    return [ChanValues,t];
        }
        
  
                            }
           }
            ChanValues -= atrBloker;
    }

    if (initialArray <= AddedConcentration) {
        switch (drug.Name) {
            case "Adrenaline (Epinephrine)":
                handleAdrenalineEffect();
                break;
            case "Alpha Beta Blocker":
                L = vNorAdr;
                y = false;
                ChanValues -= finalConc;
                break;
            case "Magnisum":
                ChanValues -= finalConc + mAchR * vNorAdr * factor;
                break;
            case "Barium":
                if (drug.FinalBathConcentration > 0.0053732519)
                    drug.FinalBathConcentration = 0.0053732519;
                ChanValues = 1000 * drug.FinalBathConcentration + Rmax * Math.min(mAchR, 1.0);
                break;
        }
        if (ChanValues > Rmax + 4) {
            ChanValues = Rmax + 4;
        }
      if (ChanValues < 0.05 && Id !== 0) {
            Update();
        }
        if (ChanValues < 0.05 && Id == 4 && atrBloker == 0) {
            Atropine();
        }
    }

    t += dt;
    ChanValues = Math.max(ChanValues, 0);
    // console.log(ChanValues + " ChanValues");

    return [ChanValues,t];
}
