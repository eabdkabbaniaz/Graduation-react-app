
var Drugs = [
  {
    "Name": "Acetylcholine",
    "ShortName": "Ach",
    "EC50_HistR": 1E6,
    "EC50_HistR_NC": 1E6,
    "EC50_nAchR": 5E-4,
    "EC50_AchEsterase": 1E-6,
    "EC50_mAchR": 4.2E-7,
    "EC50_mAchR_NC": 4.2E-7,
    "EC50_OpR": 1E30,
    "EC50_Alpha_AdrenR": 1E30,
    "EC50_Alpha2_AdrenR": 1E30,
    "EC50_Beta_AdrenR": 1E30,
    "EC50_PLC_Inhibition": 1E30,
    "EC50_CaChannelR": 1E5,
    "EC50_CaStore": 1E30,
    "EC50_BTXE": 1E30,
    "EC50_BTXB": 1E30,
    "EC50_NaChannel": 1E30,
    "EC50_KChannel": 1E5,
    "EC50_ECCoupling": 1E30,
    "EC50_Ca": 1E30,
    "EC50_CaChannelV": 1E30,
    "EC50_IP3R": 1E30,
    "EC50_Mg": 1E30,
    "Tissue": 0,
    "Units": "M",
    "Unknown": false,
    "Antagonist": false,
    "FinalBathConcentration": 0.0,
    "DisplayBathConcentration": 0.0,
    "BathConcentration": 0.0
  },
  {
    "Name": "Adrenaline",
    "ShortName": "Adr",
    "EC50_HistR": 1E30,
    "EC50_HistR_NC": 1E30,
    "EC50_nAchR": 1E30,
    "EC50_AchEsterase": 1E30,
    "EC50_mAchR": 1E30,
    "EC50_mAchR_NC": 1E30,
    "EC50_OpR": 1E30,
    "EC50_Alpha_AdrenR": 1E-5,
    "EC50_Alpha2_AdrenR": 1E-5,
    "EC50_Beta_AdrenR": 5E-6,
    "EC50_PLC_Inhibition": 1E30,
    "EC50_CaChannelR": 1E30,
    "EC50_CaStore": 1E30,
    "EC50_BTXE": 1E30,
    "EC50_BTXB": 1E30,
    "EC50_NaChannel": 1E30,
    "EC50_KChannel": 1E30,
    "EC50_ECCoupling": 1E30,
    "EC50_Ca": 1E30,
    "EC50_CaChannelV": 1E30,
    "EC50_IP3R": 1E30,
    "EC50_Mg": 1E30,
    "Tissue": 0,
    "Units": "M",
    "Unknown": false,
    "Antagonist": false,
    "FinalBathConcentration": 0.0,
    "DisplayBathConcentration": 0.0,
    "BathConcentration": 0.0
  },
  {
    "Name": "Atropine",
    "ShortName": "Atr",
    "EC50_HistR": 2E-6,
    "EC50_HistR_NC": 1E30,
    "EC50_nAchR": 1E30,
    "EC50_AchEsterase": 1E30,
    "EC50_mAchR": 1E-9,
    "EC50_mAchR_NC": 1E30,
    "EC50_OpR": 1E30,
    "EC50_Alpha_AdrenR": 1E30,
    "EC50_Alpha2_AdrenR": 1E30,
    "EC50_Beta_AdrenR": 1E30,
    "EC50_PLC_Inhibition": 1E30,
    "EC50_CaChannelR": 1E30,
    "EC50_CaStore": 1E30,
    "EC50_BTXE": 1E30,
    "EC50_BTXB": 1E30,
    "EC50_NaChannel": 1E30,
    "EC50_KChannel": 1E30,
    "EC50_ECCoupling": 1E30,
    "EC50_Ca": 1E30,
    "EC50_CaChannelV": 1E30,
    "EC50_IP3R": 1E30,
    "EC50_Mg": 1E30,
    "Tissue": 0,
    "Units": "M",
    "Unknown": false,
    "Antagonist": "True",
    "FinalBathConcentration": 0.0,
    "DisplayBathConcentration": 0.0,
    "BathConcentration": 0.0
  },
  {
    "Name": "Magnesium",
    "ShortName": "Mg",
    "EC50_HistR": 1E30,
    "EC50_HistR_NC": 1E30,
    "EC50_nAchR": 1E30,
    "EC50_AchEsterase": 1E30,
    "EC50_mAchR": 1E-3,
    "EC50_mAchR_NC": 1E-3,
    "EC50_OpR": 1E30,
    "EC50_Alpha_AdrenR": 1E30,
    "EC50_Alpha2_AdrenR": 1E30,
    "EC50_Beta_AdrenR": 1E30,
    "EC50_PLC_Inhibition": 1E30,
    "EC50_CaChannelR": 5E-4,
    "EC50_CaStore": 1E-3,
    "EC50_BTXE": 1E30,
    "EC50_BTXB": 1E30,
    "EC50_NaChannel": 1E30,
    "EC50_KChannel": 5E-3,
    "EC50_ECCoupling": 7E-4,
    "EC50_Ca": 1E30,
    "EC50_CaChannelV": 5E-4,
    "EC50_IP3R": 1E30,
    "EC50_Mg": 1.0,
    "Tissue": 0,
    "Units": "M",
    "Unknown": "False",
    "Antagonist": "True",
    "FinalBathConcentration": 0.0,
    "DisplayBathConcentration": 0.0,
    "BathConcentration": 0.0
  },
  {
    "Name": "Prazosin",
    "ShortName": "Pra",
    "EC50_HistR": 1E30,
    "EC50_HistR_NC": 1E30,
    "EC50_nAchR": 1E30,
    "EC50_AchEsterase": 1E30,
    "EC50_mAchR": 1E30,
    "EC50_mAchR_NC": 1E30,
    "EC50_OpR": 1E30,
    "EC50_Alpha_AdrenR": 3E-8,
    "EC50_Alpha2_AdrenR": 1E30,
    "EC50_Beta_AdrenR": 1E30,
    "EC50_PLC_Inhibition": 1E30,
    "EC50_CaChannelR": 1E30,
    "EC50_CaStore": 1E30,
    "EC50_BTXE": 1E30,
    "EC50_BTXB": 1E30,
    "EC50_NaChannel": 1E30,
    "EC50_KChannel": 1E30,
    "EC50_ECCoupling": 1E30,
    "EC50_Ca": 1E30,
    "EC50_CaChannelV": 1E30,
    "EC50_IP3R": 1E30,
    "EC50_Mg": 1E30,
    "Tissue": 0,
    "Units": "M",
    "Unknown": false,
    "Antagonist": "True",
    "FinalBathConcentration": 0.0,
    "DisplayBathConcentration": 0.0,
    "BathConcentration": 0.0
  },
]
initialArray = [RandomInitial(), RandomInitial(), RandomInitial(), RandomInitial(), RandomInitial()];
RMaxArray = [RandomRMax(), RandomRMax(), RandomRMax(), RandomRMax(), RandomRMax()];

function RandomInitial() {
  return Math.random() * (0.0002 - 0.000069) + 0.000069
}
function RandomRMax() {
  return Math.random() * (0.006 - 0.008000000000000002) + 0.008000000000000002

}
randNum = RandG(1.0, 0.1);

function RandG(mean, stdDev) {
  const u = 1 - Math.random();
  const v = Math.random();
  const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  return z * stdDev + mean;
}


var inhibitionFactor = 1;

let t = 0;
const waveData = [];
//ال t هي الموجة الكبيرة 
// الموجة الصغيرة بتبلش من t نهاية الموجة الكبيرة
// و بتنتهي لعند ربع الكبيرة 
// var T = 2 * Math.PI +inhibitionFactor;     // دورة كاملة للموجة الكبيرة
// var smallStart = T;      // بداية الموجة الصغيرة
// var smallEnd = T + T * 0.25; // نهاية الموجة الصغيرة
// var fullCycle = T + T * 0.25; // دورة النبضة الكاملة
let baseT = 2 * Math.PI;
let stretchRatio = 1.0; // 100% by default
let T = baseT;
let smallStart = T;
let smallEnd = T + T * 0.25;
let fullCycle = smallEnd;

//pulseCount: عدد النبضات المرسومة.
//lastCycle: يحتفظ بالدورة السابقة لمقارنة هل بدأنا دورة جديدة أم لا.
let pulseCount = 0;
let lastCycle = 0;


let pendingStretchRatio = null;



function Clean() {
  MgEffect=1;
  for (i = 0; i < Drugs.length; i++) {
    Drugs[i]["BathConcentration"] = 0.0;
    Drugs[i]["DisplayBathConcentration"] = 0.0;
    Drugs[i]["FinalBathConcentration"] = 0.0;

  }
  inhibitionFactor = 1;
  effectiveInhibition = 1;
  alphaBlock = 0;
  atropineBlock = 0;
  Id = 100;
  AddedConcentration = 0.0;
  InitialMixing = 1;
  newDisplayBathConcentration = 0.0;
  newFinalBathConcen = 0.0;
}
var newDisplayBathConcentration = 0.0;
var newFinalBathConcentration = 0.0;

function FinalBathConcentration(StockConcentration, DrugsId, Volume) {
  Id = DrugsId;
  AddedConcentration = (StockConcentration * Volume) / BathVolume;
  if (RMaxArray[Id] < AddedConcentration) {
    AddedConcentration = RMaxArray[Id];
  }
  console.log(AddedConcentration);
  newDisplayBathConcentration = (Drugs[DrugsId].DisplayBathConcentration + AddedConcentration).toFixed(10);
  newFinalBathConcentration = (Drugs[DrugsId].FinalBathConcentration + AddedConcentration * randNum).toFixed(10);
  Update();


}
var InitialMixing = 1;
const MaxMixingRate = 0.5;
function updatBathConcentration() {
  MixingRate = (MaxMixingRate * InitialMixing) / (100.0 + InitialMixing);
  for (i = 0; i < Drugs.length; i++) {
    dConc = (Drugs[i].FinalBathConcentration - Drugs[i].BathConcentration) * MixingRate * 0.15;
    Drugs[i].BathConcentration = Math.max(Drugs[i].BathConcentration + dConc, 0.0);
  }

  InitialMixing = InitialMixing + 1;
}
function Update() {
  if (newDisplayBathConcentration == 0 || newFinalBathConcentration == 0) {
    return;
  }
  Drugs[Id].DisplayBathConcentration = parseFloat(newDisplayBathConcentration);
  Drugs[Id].FinalBathConcentration = parseFloat(newFinalBathConcentration);
  updatBathConcentration();
  if (Drugs[Id].ShortName === "Ach") {


    Ach();
  }
  if (initialArray[Id] < AddedConcentration) {
    if (Drugs[Id].ShortName === "Atr") {
      //  //console.log("dddddddd");
      Atr();
    }
    if (Drugs[Id].ShortName === "Pra") {
      Pra();
    }
    if (Drugs[Id].ShortName === "Adr") {
      Adr();
    }
    if (Drugs[Id].ShortName === "Mg") {
      Mg();
    }
    updateStretch();
  }
}
var BathVolume = 10;
var atropineBlock = 0;

function Ach() {
  const EC50_nAchR = Drugs[Id].EC50_nAchR;
  const EC50_mAchR = Drugs[Id].EC50_mAchR;
  // //console.log(Id)
  const effect_nAchR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_nAchR);
  const effect_mAchR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_mAchR);
  //ثوابت 
  const w1 = 0.6;
  const w2 = 0.05;
  //بحسب الحجب وبضربو ب الثابت دابليو
  const inhibitedEffect_mAchR = effect_mAchR * (1 - atropineBlock);
  // //console.log(w1 * inhibitedEffect_mAchR + w2 * effect_nAchR)
  if (atropineBlock > 0) {
    inhibitionFactor = Math.abs(Math.max(0, inhibitionFactor - (w1 * inhibitedEffect_mAchR + w2 * effect_nAchR)) - 100 * (Drugs[Id].FinalBathConcentration));
    if (inhibitionFactor === 0) inhibitionFactor = 1;
    ////console.log(Drugs[Id].FinalBathConcentration)

  }

  else {
    inhibitionFactor = Math.abs(Math.max(0, (w1 * inhibitedEffect_mAchR + w2 * effect_nAchR)) - 100 * (Drugs[Id].FinalBathConcentration));
    ////console.log("inhibitionFactor      " + Drugs[Id].FinalBathConcentration)

  }
}

function hillEquation(FinalBathConcentration, EC50) {
  return FinalBathConcentration / (FinalBathConcentration + EC50);
}

function Atr() {


  const EC50_mAchR = Drugs[Id].EC50_mAchR;
  const antagonistFactor = hillEquation(Drugs[Id].FinalBathConcentration, EC50_mAchR);
  const w1 = 0.6;
  atropineBlock = w1 * antagonistFactor;
  inhibitionFactor = Math.abs(Math.max(0, (1 + Math.min(atropineBlock, 1))) + 1000 * (Drugs[Id].FinalBathConcentration));
  ////console.log(Drugs[Id].FinalBathConcentration)

}

function Pra() {
  const EC50_Alpha_AdrenR = Drugs[Id].EC50_Alpha_AdrenR;
  const antagonistFactor = hillEquation(Drugs[Id].FinalBathConcentration, EC50_Alpha_AdrenR);
  const w1 = 0.5;
  alphaBlock = w1 * antagonistFactor;
  effectiveInhibition = Math.abs(Math.max(0, 1 - Math.min(alphaBlock, 1)) - 100 * (Drugs[Id].FinalBathConcentration));



}
var alphaBlock = 0;
function Adr() {

  const EC50_Alpha_AdrenR = Drugs[Id].EC50_Alpha_AdrenR;
  const EC50_Alpha2_AdrenR = Drugs[Id].EC50_Alpha2_AdrenR;
  const EC50_Beta_AdrenR = Drugs[Id].EC50_Beta_AdrenR;

  const effect_Alpha_AdrenR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_Alpha_AdrenR);
  const effect_Alpha2_AdrenR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_Alpha2_AdrenR);
  const effect_Beta_AdrenR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_Beta_AdrenR);
  const w1 = 0.4;
  const w2 = 0.2;
  const w3 = 0.7;

  const inhibitedEffect_Alpha_AdrenR = effect_Alpha_AdrenR * (1 - alphaBlock);
  inhibitionFactor = w1 * inhibitedEffect_Alpha_AdrenR + w2 * effect_Alpha2_AdrenR + w3 * effect_Beta_AdrenR;
  if (atropineBlock > 0) {
    effectiveInhibition = Math.abs(Math.max(0, (effectiveInhibition - Math.min(inhibitionFactor, 1))) + 100 * (Drugs[Id].FinalBathConcentration));

    if (effectiveInhibition === 0) effectiveInhibition = 1;
    ////console.log(Drugs[Id].FinalBathConcentration)

  }

  else {
    effectiveInhibition = Math.abs(Math.max(0, (Math.min(inhibitionFactor, 1))) + 100 * (Drugs[Id].FinalBathConcentration));
    ////console.log("inhibitionFactor      " + Drugs[Id].FinalBathConcentration)

  }

  //console.log("effectiveInhibition      " + effectiveInhibition);

}
function Mg() {

  const EC50_mAchR = Drugs[Id].EC50_mAchR;
  const EC50_CaChannelR = Drugs[Id].EC50_CaChannelR;
  const EC50_KChannel = Drugs[Id].EC50_KChannel;
  const EC50_ECCoupling = Drugs[Id].EC50_ECCoupling;
  const effect_mAchR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_mAchR);
  const effect_CaChannelR = hillEquation(Drugs[Id].FinalBathConcentration, EC50_CaChannelR);
  const effect_KChannel = hillEquation(Drugs[Id].FinalBathConcentration, EC50_KChannel);
  const effect_ECCoupling = hillEquation(Drugs[Id].FinalBathConcentration, EC50_ECCoupling);
  const w1 = 0.3;
  const w2 = 0.4;
  const w3 = 0.2;
  const w4 = 0.1;
  const inhibitionFactor = w1 * effect_mAchR + w2 * effect_CaChannelR + w3 * effect_KChannel +
    w4 * effect_ECCoupling;

  MgEffect = 2 * Math.max(0, (1 - Math.min(inhibitionFactor, 1)));
  if (MgEffect == 0) {
    MgEffect = 1;
  }
  // }
  // newAmplitude = amplitude * effectiveInhibition;
  // frequency = frequency * effectiveInhibition;
  // console.log("newAmplitude: " + NewDrugs[id].ShortName + " " + newAmplitude);
  // console.log("frequency: " + NewDrugs[id].ShortName + " " + frequency);
  //console.log("effectiveInhibition      " + effectiveInhibition);

}
var effectiveInhibition = 1;
//           function frogPulse(t) {
// var T = 2 * Math.PI ;     // دورة كاملة للموجة الكبيرة
// var smallStart = T;      // بداية الموجة الصغيرة
// var smallEnd = T + T * 0.25; // نهاية الموجة الصغيرة
// var fullCycle = T + T * 0.25; // دورة النبضة الكاملة

//             const localT = t % fullCycle;

//   // موجة كبيرة
//   if (localT <= T) {
//     return  Math.sin(localT) * 30;
//   }
//   // موجة صغيرة
//   else if (localT > T && localT <= smallEnd) {
//     const smallT = (localT - T) / (smallEnd - smallStart) * Math.PI;
//     return Math.sin(smallT) * 8;
//   }

//   return 0;
// }
function updateStretch() {
  // const userInput = document.getElementById("stretchFactor").value;
  pendingStretchRatio = inhibitionFactor; // تحويل من نسبة إلى رقم عشري

  // T = baseT / stretchRatio;
  // smallStart = T;
  // smallEnd = T + T * 0.25;
  // fullCycle = smallEnd;
}

function frogPulse(t) {
  const localT = t % fullCycle;

  if (localT <= T) {
    return Math.sin(localT / T * 2 * Math.PI) * (30 * inhibitionFactor);
  } else if (localT > T && localT <= smallEnd) {
    const smallT = (localT - T) / (smallEnd - smallStart) * Math.PI;
    return Math.sin(smallT) * (8 * inhibitionFactor);
  }

  return 0;
}

function stimulation() {

  // requestAnimationFrame(draw);

  // تحديث العداد عند نهاية كل دورة كاملة
  currentCycle = Math.floor(t / fullCycle);

  if (pendingStretchRatio !== null) {
    stretchRatio = pendingStretchRatio;
    T = baseT;
    smallStart = T;
    smallEnd = T + T * 0.25;
    fullCycle = smallEnd;
    pendingStretchRatio = null; // تطبيق التحديث
  }

  if (currentCycle > lastCycle) {
    pulseCount++;
    // document.getElementById('counter').innerText = `النبضات: ${pulseCount}`;

  }
  //  currentCycle = Math.floor(t / fullCycle);
  lastCycle = currentCycle;

  const y = frogPulse(t);
  var dt = 0.05 * inhibitionFactor * effectiveInhibition * MgEffect;
  t += dt;
  console.log("MgEffect    " + MgEffect);
  return [t, y, dt];
}
MgEffect = 1
function pulse() {
  return pulseCount;
}